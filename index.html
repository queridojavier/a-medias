<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A Medias</title>

  <!-- Tailwind por CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <link rel="icon" href="./icons/icon-192.png" type="image/png">
  <meta name="apple-mobile-web-app-title" content="A Medias">
  <meta name="theme-color" content="#EF7D70">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Estilo de marca y tarjetas -->
  <style>
    :root{
      --primary:#EF7D70;      /* salmón */
      --primary-700:#E15F54;
      --ink:#0f172a;
      --muted:#e5e7eb;
      --card:#ffffff;
      --bg:#f7f8fb;
    }
    body{ font-family:'Inter',system-ui,sans-serif; background: var(--bg); }
    .card{
      background:var(--card);
      border-radius:16px;
      border:1px solid #e6e8ef;
      box-shadow:0 8px 24px rgba(15,23,42,.06);
      padding:1.25rem;
    }
    .result-box{ border-radius:16px; padding:1.25rem; text-align:center; }
    .brand-dot{ width:.7rem; height:.7rem; border-radius:999px; display:inline-block; }
      .badge-success{
    background: rgba(16,185,129,.14);
    color: #0f7a4e;
    padding: .15rem .5rem;
    border-radius: .5rem;
  }
  .donut{
    background: conic-gradient(var(--primary) 60%, var(--muted) 0);
  }
  </style>
</head>

<body class="text-slate-800 flex items-center justify-center min-h-screen p-4">
  <main class="w-full max-w-4xl mx-auto">
    <div class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight" style="color:var(--ink)">
        A <span style="color:var(--primary)">Medias</span>
      </h1>
      <p class="text-slate-600 mt-2">Calculadora rápida para repartir gastos en pareja.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
      <!-- Columna de Entradas -->
      <div class="lg:col-span-2 space-y-6">
        <div class="card">
          <h2 class="text-xl font-semibold mb-4 text-slate-700">1. Datos del Mes</h2>

          <!-- Toggle de modo -->
          <div class="mb-5">
            <label class="block text-sm font-medium text-slate-600 mb-2">Modo de reparto</label>
            <div class="inline-flex rounded-xl bg-slate-100 p-1" role="group" aria-label="Modo de reparto">
              <button id="mode-prop"
                      class="px-3 py-1.5 rounded-lg text-sm font-medium bg-white shadow text-slate-900 ring-1 ring-[var(--primary)]"
                      type="button" aria-pressed="true">
                Proporcional
              </button>
              <button id="mode-eq"
                      class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-700 hover:text-slate-900"
                      type="button" aria-pressed="false">
                50 / 50
              </button>
            </div>
            <p id="mode-hint" class="text-xs text-slate-500 mt-2">Reparte según el peso de cada nómina.</p>
          </div>

          <!-- Ingresos -->
          <div class="space-y-4">
            <div>
              <label for="nomina1" class="block text-sm font-medium text-slate-600 mb-1">Tu nómina</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                <input type="number" id="nomina1" class="pl-7 w-full rounded-lg border border-slate-300 py-2 focus:outline-none focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200"
                       placeholder="1800" value="1800" step="0.01" inputmode="decimal" min="0">
              </div>
            </div>
            <div>
              <label for="nomina2" class="block text-sm font-medium text-slate-600 mb-1">Nómina de tu pareja</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                <input type="number" id="nomina2" class="pl-7 w-full rounded-lg border border-slate-300 py-2 focus:outline-none focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200"
                       placeholder="1500" value="1500" step="0.01" inputmode="decimal" min="0">
              </div>
            </div>
          </div>

          <!-- Fondo común y ajuste -->
          <div class="mt-6 pt-6 border-t border-slate-200 space-y-4">
            <div>
              <label for="fondoComun" class="block text-sm font-medium text-slate-600 mb-1">Aportación a la cuenta común</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                <input type="number" id="fondoComun" class="pl-7 w-full rounded-lg border border-slate-300 py-2 focus:outline-none focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200"
                       placeholder="1200" value="1200" step="0.01" inputmode="decimal" min="0">
              </div>
            </div>
            <div>
              <label for="ajuste" class="block text-sm font-medium text-slate-600 mb-1">Ajuste entre vosotros</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">€</span>
                <input type="number" id="ajuste" class="pl-7 w-full rounded-lg border border-slate-300 py-2 focus:outline-none focus:border-indigo-600 focus:ring-2 focus:ring-indigo-200"
                       placeholder="0" value="0" step="0.01" inputmode="decimal">
              </div>
              <p class="text-xs text-slate-500 mt-1.5">Positivo si te deben a ti, negativo si debes tú.</p>
            </div>
          </div>

          <!-- Acciones -->
          <div class="mt-6 flex items-center gap-3">
            <button id="btnReset"
                    class="px-3 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-sm">
              Restablecer valores
            </button>
          </div>
        </div>
      </div>

      <!-- Columna de Resultados -->
      <div class="lg:col-span-3 space-y-6">
        <div class="card" aria-live="polite">
          <h2 class="text-xl font-semibold mb-4 text-slate-700">2. Resumen y reparto</h2>

          <div class="space-y-3 text-slate-600">
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
              <span class="font-medium">Ingresos totales:</span>
              <span id="ingresoTotal" class="font-bold text-lg text-slate-800">3.300,00 €</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
              <span class="font-medium">Dinero a repartir:</span>
              <span id="dineroRepartir" class="badge-success font-bold text-lg">2.100,00 €</span>
            </div>

            <!-- Donut + leyenda -->
            <div class="mt-4 pt-4 border-t border-slate-200">
              <h3 class="font-semibold text-center mb-3">Distribución</h3>
              <div class="flex items-center justify-center gap-6">
                <!-- Donut -->
                <div class="relative w-36 h-36 rounded-full donut" id="donut" aria-label="Distribución de aportación">
  <div class="absolute inset-6 rounded-full bg-white ring-1 ring-[#e6e8ef]"></div>
  <div class="absolute inset-0 grid place-items-center">
    <span id="p1Center" class="font-extrabold text-2xl" style="color:var(--ink)">60%</span>
  </div>
</div>
                <!-- Leyenda -->
                <ul class="text-sm text-slate-600">
                  <li class="mb-2">
                    <span class="brand-dot" style="background:var(--primary)"></span>
                    <span class="font-medium text-slate-700">Tu parte</span>:
                    <span id="porcentaje1" class="font-semibold">60%</span>
                  </li>
                  <li>
                    <span class="brand-dot" style="background:var(--muted); border:1px solid #cdd1d8"></span>
                    <span class="font-medium text-slate-700">Pareja</span>:
                    <span id="porcentaje2" class="font-semibold">40%</span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Aportaciones al fondo -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4 text-sm text-slate-600">
              <div class="p-3 bg-slate-50 rounded-lg">
                <span class="font-medium">Tu aportación al fondo:</span> <span id="comun1">—</span>
              </div>
              <div class="p-3 bg-slate-50 rounded-lg">
                <span class="font-medium">Aportación pareja:</span> <span id="comun2">—</span>
              </div>
            </div>

            <!-- Aviso -->
            <p id="warning" class="mt-2 text-sm text-amber-700"></p>
          </div>
        </div>

        <div class="card" aria-live="polite">
          <h2 class="text-xl font-semibold mb-4 text-slate-700">3. ✅ Resultado final: transferencias</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="result-box" style="background:rgba(239,125,112,.12); color:#3f2c2b; border:1px solid #f3d1cd">
              <h3 class="font-semibold mb-2">Transferir a tu cuenta</h3>
              <p id="transferencia1" class="text-3xl font-extrabold">1.095,45 €</p>
            </div>
            <div class="result-box" style="background:rgba(16,185,129,.12); color:#135b46; border:1px solid #cbe9db">
              <h3 class="font-semibold mb-2">Transferir a cuenta pareja</h3>
              <p id="transferencia2" class="text-3xl font-extrabold">1.004,55 €</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-8 text-sm text-slate-500">
      <p>Creado para una gestión financiera clara y justa.</p>
    </footer>
  </main>

  <!-- Registro del Service Worker (desactivado en desarrollo/local) -->
  <script>
    const isDevHost = ['localhost','127.0.0.1'].includes(location.hostname) || location.hostname.startsWith('192.168.');
    if ('serviceWorker' in navigator && !isDevHost) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    } else {
      // Si estás en local, intenta desregistrar SWs previos y limpiar cachés
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
      }
      if ('caches' in window) {
        caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      }
    }
  </script>

  <!-- Lógica de la app -->
  <script>
    // Utilidades
    const money = n => new Intl.NumberFormat('es-ES', {
      style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2
    }).format(n);
    const fmtPct = n => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(n);
    const round2 = n => Math.round((Number(n) + Number.EPSILON) * 100) / 100;

    const read = (id, { allowNegative = false } = {}) => {
      const el = document.getElementById(id);
      if (!el) return 0;
      let v = String(el.value ?? '').replace(',', '.');
      v = parseFloat(v);
      if (Number.isNaN(v)) v = 0;
      if (!allowNegative) v = Math.max(0, v);
      return v;
    };

    // Estado
    let mode = 'prop'; // 'prop' | 'eq'
    const saveState = () => {
      const data = {
        nomina1: read('nomina1'),
        nomina2: read('nomina2'),
        fondoComun: read('fondoComun'),
        ajuste: read('ajuste', { allowNegative: true }),
        mode
      };
      localStorage.setItem('parejas_calc', JSON.stringify(data));
    };

    const loadState = () => {
      try {
        const data = JSON.parse(localStorage.getItem('parejas_calc') || '{}');
        if (data.nomina1 != null) document.getElementById('nomina1').value = data.nomina1;
        if (data.nomina2 != null) document.getElementById('nomina2').value = data.nomina2;
        if (data.fondoComun != null) document.getElementById('fondoComun').value = data.fondoComun;
        if (data.ajuste != null) document.getElementById('ajuste').value = data.ajuste;
        if (data.mode === 'eq' || data.mode === 'prop') mode = data.mode;
      } catch {}
    };

    // Cálculo principal
    function calculate() {
      const nomina1 = read('nomina1');
      const nomina2 = read('nomina2');
      const fondoComun = read('fondoComun');
      const ajuste = read('ajuste', { allowNegative: true });

      const ingresoTotal = round2(nomina1 + nomina2);

      // Porcentaje según modo
      let p1 = mode === 'eq'
        ? 0.5
        : (ingresoTotal > 0 ? nomina1 / ingresoTotal : 0.5);
      p1 = Math.min(1, Math.max(0, p1));

      const comun1 = round2(fondoComun * p1);
      const comun2 = round2(fondoComun * (1 - p1));

      let dineroRepartir = round2(ingresoTotal - fondoComun);

      const warningEl = document.getElementById('warning');
      if (warningEl) warningEl.textContent = '';
      if (dineroRepartir < 0) {
        dineroRepartir = 0;
        if (warningEl) warningEl.textContent =
          'La aportación a la cuenta común supera los ingresos totales. Revisa las cifras.';
      }

      const sobrante1 = round2(nomina1 - comun1);
      const sobrante2 = round2(nomina2 - comun2);

      const transferencia1 = round2(sobrante1 - ajuste);
      const transferencia2 = round2(sobrante2 + ajuste);

      // Pintar UI
      document.getElementById('ingresoTotal').textContent = money(ingresoTotal);
      document.getElementById('dineroRepartir').textContent = money(dineroRepartir);

      const p1pct = p1 * 100;
      document.getElementById('porcentaje1').textContent = `${fmtPct(p1pct)}%`;
      document.getElementById('porcentaje2').textContent = `${fmtPct(100 - p1pct)}%`;

      // Donut
      const p1deg = Math.round(p1 * 360);
      const donut = document.getElementById('donut');
      if (donut) donut.style.background = `conic-gradient(var(--primary) ${p1deg}deg, var(--muted) 0)`;
      const p1Center = document.getElementById('p1Center');
      if (p1Center) p1Center.textContent = `${fmtPct(p1pct)}%`;

      // Aportaciones y resultados
      document.getElementById('comun1').textContent = money(comun1);
      document.getElementById('comun2').textContent = money(comun2);
      document.getElementById('transferencia1').textContent = money(transferencia1);
      document.getElementById('transferencia2').textContent = money(transferencia2);

      saveState();
    }

    // UI del modo
    function updateModeUI() {
      const btnProp = document.getElementById('mode-prop');
      const btnEq = document.getElementById('mode-eq');
      const hint = document.getElementById('mode-hint');

      if (mode === 'prop') {
        btnProp.className = "px-3 py-1.5 rounded-lg text-sm font-medium bg-white shadow text-slate-900 ring-1 ring-[var(--primary)]";
        btnEq.className = "px-3 py-1.5 rounded-lg text-sm font-medium text-slate-700 hover:text-slate-900";
        btnProp.setAttribute('aria-pressed','true'); btnEq.setAttribute('aria-pressed','false');
        hint.textContent = "Reparte según el peso de cada nómina.";
      } else {
        btnEq.className = "px-3 py-1.5 rounded-lg text-sm font-medium bg-white shadow text-slate-900 ring-1 ring-[var(--primary)]";
        btnProp.className = "px-3 py-1.5 rounded-lg text-sm font-medium text-slate-700 hover:text-slate-900";
        btnEq.setAttribute('aria-pressed','true'); btnProp.setAttribute('aria-pressed','false');
        hint.textContent = "Reparte exactamente al 50% cada concepto.";
      }
    }

    function setMode(m){
      mode = m;
      updateModeUI();
      calculate();
    }

    // Bootstrap
    let defaultState = {};
    window.onload = () => {
      defaultState = {
        nomina1: parseFloat(document.getElementById('nomina1').value) || 0,
        nomina2: parseFloat(document.getElementById('nomina2').value) || 0,
        fondoComun: parseFloat(document.getElementById('fondoComun').value) || 0,
        ajuste: parseFloat(document.getElementById('ajuste').value) || 0
      };

      loadState();
      updateModeUI();
      calculate();

      const inputs = ['nomina1','nomina2','fondoComun','ajuste'];
      let t;
      inputs.forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => { clearTimeout(t); t = setTimeout(calculate, 80); });
      });

      document.getElementById('btnReset')?.addEventListener('click', () => {
        try { localStorage.removeItem('parejas_calc'); } catch {}
        document.getElementById('nomina1').value = defaultState.nomina1 ?? 0;
        document.getElementById('nomina2').value = defaultState.nomina2 ?? 0;
        document.getElementById('fondoComun').value = defaultState.fondoComun ?? 0;
        document.getElementById('ajuste').value = defaultState.ajuste ?? 0;
        mode = 'prop';
        updateModeUI();
        calculate();
      });

      document.getElementById('mode-prop').addEventListener('click', () => setMode('prop'));
      document.getElementById('mode-eq').addEventListener('click', () => setMode('eq'));
    };
  </script>
</body>
</html>